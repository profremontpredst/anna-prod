<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ì–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –±–∏–∑–Ω–µ—Å–∞</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f4f4f4;
      color: #333;
    }

    header {
      background-color: #f5faff;
      text-align: center;
      padding: 30px 20px 10px;
      border-bottom: 1px solid #ddd;
    }

    header img.logo {
      width: 120px;
      margin-bottom: 10px;
    }

    header h1 {
      font-size: 28px;
      margin: 10px 0 5px;
      color: #003366;
    }

    header p {
      font-size: 16px;
      margin: 0 0 20px;
    }

    .cta-button {
      background: linear-gradient(to bottom, #3BC5FE, #1E90FF);
      color: #fff;
      padding: 15px 30px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }

    .main-photo {
      max-width: 300px;
      display: block;
      margin: 20px auto 10px;
    }

    .section {
      background-color: #fff;
      padding: 25px 20px;
      margin: 20px auto;
      max-width: 800px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .highlight {
      background-color: rgba(0, 46, 95, 0.1);
      color: #003366;
      text-align: center;
      padding: 30px 20px;
      font-size: 20px;
      font-weight: bold;
      border-radius: 8px;
      margin: 30px auto;
      max-width: 800px;
    }

    .section h2 {
      font-size: 22px;
      margin-bottom: 15px;
    }

    .section ul {
      list-style: none;
      padding-left: 0;
    }

    .section ul li {
      margin-bottom: 12px;
      position: relative;
      padding-left: 25px;
    }

    .section ul li::before {
      content: "‚úì";
      position: absolute;
      left: 0;
      color: green;
      font-weight: bold;
    }

    .quote {
      font-style: italic;
      margin-top: 15px;
      color: #666;
    }

    @media (max-width: 600px) {
      .cta-button {
        width: 100%;
        font-size: 16px;
      }

      .main-photo {
        max-width: 90%;
      }

      header h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>

  <header>
    <img src="https://i.imgur.com/giZWpMe.png" alt="–õ–æ–≥–æ—Ç–∏–ø" class="logo" />
    <h1>–ì–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ —Å–∞–π—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–¥–∞—ë—Ç</h1>
    <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ‚Äî –∏ —É—Å–ª—ã—à–∏—Ç–µ, –∫–∞–∫ –¥–æ–ª–∂–µ–Ω –∑–≤—É—á–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å</p>
    <button class="cta-button">üé§ –ì–æ–≤–æ—Ä–∏—Ç—å —Å –±–æ—Ç–æ–º</button>
  </header>

  <img src="https://i.imgur.com/fsQiE0g.png" alt="–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç" class="main-photo" />

  <div class="highlight">
    üéß –¢–û–ü-1 –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –≥–æ–ª–æ—Å–∞ ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å —Å–∞–º–∏!<br>
    –ë–æ—Ç –≥–æ–≤–æ—Ä–∏—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, —Å —ç–º–æ—Ü–∏—è–º–∏ –∏ —Ç–µ–ø–ª–æ–º ‚Äî —Å –Ω–∏–º –ø—Ä–∏—è—Ç–Ω–æ –æ–±—â–∞—Ç—å—Å—è, –∫–∞–∫ —Å –∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º.
  </div>

  <div class="section">
    <h2>üî• 1. –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç (–Ω–∏–∫–∞–∫–∏—Ö –æ–∂–∏–¥–∞–Ω–∏–π)</h2>
    <ul>
      <li>‚ùå –ö–æ–ª–ª-—Ü–µ–Ω—Ç—Ä: –∑–∞—è–≤–∫–∞ ‚Üí –æ–∂–∏–¥–∞–Ω–∏–µ ‚Üí –ø–æ—Ç–µ—Ä—è –∫–ª–∏–µ–Ω—Ç–∞</li>
      <li>‚úÖ –ë–æ—Ç: –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É ‚Äî –æ—Ç–≤–µ—Ç –∑–∞ 1 —Å–µ–∫—É–Ω–¥—É</li>
    </ul>
    <p class="quote">–§–∏—à–∫–∞: –≠—Ç–æ –∫–∞–∫ ¬´–∫—É–ø–∏ —Å–µ–π—á–∞—Å¬ª –≤–º–µ—Å—Ç–æ ¬´–º—ã –≤–∞–º –ø–µ—Ä–µ–∑–≤–æ–Ω–∏–º¬ª.</p>
  </div>

  <div class="section">
    <h2>üí∞ 2. –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ 2‚Äì3 —Ä–∞–∑–∞ –≤—ã—à–µ</h2>
    <ul>
      <li>‚ùå 100 –∑–∞—è–≤–æ–∫ ‚Üí 5 –ø—Ä–æ–¥–∞–∂ —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</li>
      <li>‚úÖ 100 –∫–ª–∏–∫–æ–≤ ‚Üí 15‚Äì20 –ø—Ä–æ–¥–∞–∂ —á–µ—Ä–µ–∑ –±–æ—Ç–∞</li>
    </ul>
    <p class="quote">–§–∏—à–∫–∞: –ö–ª–∏–µ–Ω—Ç —É–∂–µ –≤ –¥–∏–∞–ª–æ–≥–µ ‚Äî –Ω–µ –Ω—É–∂–Ω–æ —É–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å</p>
  </div>

  <div class="section">
    <h2>ü§ñ 3. –†–∞–±–æ—Ç–∞–µ—Ç 24/7 –±–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</h2>
    <ul>
      <li>–û—Ç–≤–µ—Ç–∏—Ç –¥–∞–∂–µ –≤ 3 –Ω–æ—á–∏</li>
      <li>–ë–µ–∑ –æ–∫–ª–∞–¥–æ–≤, –æ—Ç–ø—É—Å–∫–æ–≤ –∏ –æ—à–∏–±–æ–∫</li>
    </ul>
    <p class="quote">–§–∏—à–∫–∞: –õ–æ–≤–∏—à—å –∫–ª–∏–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã —Ç–µ—Ä—è—é—Ç –Ω–æ—á—å—é</p>
  </div>

  <div class="section">
    <h2>üéØ 4. –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ —É—Å–∏–ª–∏–π</h2>
    <ul>
      <li>–ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ç–æ, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —Ä–µ–∞–ª—å–Ω–æ –∏—Å–∫–∞–ª</li>
      <li>–£—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ</li>
    </ul>
    <p class="quote">–§–∏—à–∫–∞: –ö–∞–∫ –ø—Ä–æ–¥–∞–≤–µ—Ü —Å –ø–∞–º—è—Ç—å—é, –Ω–æ –±–µ–∑ –∑–∞—Ä–ø–ª–∞—Ç—ã</p>
  </div>

  <div class="section">
    <h2>üìä 5. –ü–æ–ª–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
    <ul>
      <li>–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã</li>
      <li>–°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ñ—Ä–∞–∑–∞–º, –≤—Ä–µ–º–µ–Ω–∏, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</li>
    </ul>
    <p class="quote">–§–∏—à–∫–∞: –¢—ã —Ä–µ–∞–ª—å–Ω–æ –∑–Ω–∞–µ—à—å, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</p>
  </div>

  <div class="section" style="text-align: center;">
    <h2>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</h2>
    <p class="quote">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ‚Äî –∏ —É—Å–ª—ã—à–∏—Ç–µ, –∫–∞–∫ –∑–≤—É—á–∏—Ç –ª—É—á—à–∏–π –≥–æ–ª–æ—Å–æ–≤–æ–π —Å–µ—Ä–≤–∏—Å</p>
    <button class="cta-button">üé§ –ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥</button>
  </div>
<!-- üé§ –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ -->
<button id="mic-btn" style="display:none;"></button>
<div id="voice-indicator" style="display:none; position:fixed; bottom:95px; right:34px; width:12px; height:12px; border-radius:50%; background-color:limegreen; animation:pulse 1s infinite ease-in-out;"></div>
<audio id="audio-player" autoplay></audio>

<div id="lead-form-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px 25px; border-radius:10px; width:90%; max-width:400px; position:relative;">
    <button onclick="closeLeadForm()" style="position:absolute; top:10px; right:15px; font-size:18px; background:none; border:none; cursor:pointer;">‚úï</button>
    <h3 style="margin-top:0;">–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É</h3>
    <p style="margin-bottom:10px;">–ú—ã –ø–µ—Ä–µ–∑–≤–æ–Ω–∏–º –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è</p>
    <form id="lead-form" onsubmit="submitLead(event)">
      <input type="text" id="name" name="name" placeholder="–í–∞—à–µ –∏–º—è" required style="width:100%;padding:10px;margin-bottom:10px;">
      <input type="tel" id="phone" name="phone" value="+7" required style="width:100%;padding:10px;margin-bottom:15px;" maxlength="12">
      <button type="submit" style="width:100%;padding:10px;background:#003366;color:#fff;border:none;border-radius:5px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>
</div>

<script>
  const OPENAI_PROXY_URL = "http://62.171.164.184:3001/gpt";
  const STREAM_URL = "ws://62.171.164.184:3000/stream";
  const LEAD_URL = "http://62.171.164.184:3001/lead";

  let userId = localStorage.getItem("userId") || "user_" + Math.random().toString(36).substr(2, 9);
  localStorage.setItem("userId", userId);

  let messages = [], chatHistory = [], isRunning = false, greeted = false;

  let audioContext = null; // ‚Üê —Å–æ–∑–¥–∞—ë–º –ø–æ–∑–∂–µ, –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞

  const escapeHTML = str => String(str).replace(/</g, "&lt;").replace(/>/g, "&gt;");

  const renderChat = () => {};

  async function recognizeSpeech(timeout = 10000) {
    return new Promise((resolve, reject) => {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return reject("SpeechRecognition –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
      const recognition = new SR();
      recognition.lang = "ru-RU";
      recognition.interimResults = false;
      const timer = setTimeout(() => {
        recognition.stop();
        reject("‚è±Ô∏è –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ");
      }, timeout);
      recognition.onresult = event => {
        clearTimeout(timer);
        recognition.stop();
        resolve(event.results[0][0].transcript);
      };
      recognition.onerror = err => {
        clearTimeout(timer);
        recognition.stop();
        reject(err.error || "–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è");
      };
      recognition.start();
    });
  }

  async function askGPT() {
    if (!messages.length) return "–Ø –≤–∞—Å –Ω–µ —Ä–∞—Å—Å–ª—ã—à–∞–ª–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
    const res = await fetch(OPENAI_PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, messages: messages.slice(-10) })
    });
    const data = await res.json();
    if (data.choices?.[0]?.message?.triggerForm) openLeadForm();
    return data.choices?.[0]?.message?.content || "‚ùå GPT –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª";
  }

  async function playTTS(text) {
    const indicator = document.getElementById("voice-indicator");
    indicator.style.display = "block";

    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }

    const ws = new WebSocket(STREAM_URL);
    ws.binaryType = "arraybuffer";

    ws.onmessage = async (event) => {
      try {
        const arrayBuffer = event.data;
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);
        source.start();
      } catch (e) {
        console.warn("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:", e);
      }
    };

    ws.onopen = () => {
      ws.send(text);
    };

    ws.onclose = () => {
      indicator.style.display = "none";
    };

    ws.onerror = () => {
      indicator.style.display = "none";
    };
  }

  async function dialogLoop() {
    if (isRunning) return;
    isRunning = true;
    try {
      if (!greeted) {
        greeted = true;
        const reply = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ê–Ω–Ω–∞, –≤–∞—à –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç. –ú–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å ‚Äî —è –ø–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è.";
        chatHistory.push({ role: "assistant", content: reply });
        await playTTS(reply);
        await new Promise(r => setTimeout(r, 200));
      }

      while (true) {
        await new Promise(r => setTimeout(r, 500));
        const userText = await recognizeSpeech();
        if (!userText || userText.trim().length < 1) continue;

        messages.push({ role: "user", content: userText });
        chatHistory.push({ role: "user", content: userText });

        const reply = await askGPT();
        messages.push({ role: "assistant", content: reply });
        chatHistory.push({ role: "assistant", content: reply });

        await playTTS(reply);
        await new Promise(r => setTimeout(r, 200));
      }
    } catch (err) {
      console.warn("üí• –û—à–∏–±–∫–∞:", err);
    } finally {
      isRunning = false;
    }
  }

  function openLeadForm() {
    document.getElementById('lead-form-overlay').style.display = 'flex';
    document.getElementById('lead-form').reset();
    setTimeout(() => {
      document.getElementById('name').focus();
    }, 200);
  }

  function closeLeadForm() {
    document.getElementById('lead-form-overlay').style.display = 'none';
  }

  async function submitLead(event) {
    event.preventDefault();
    const name = document.getElementById("name").value.trim();
    let rawPhone = document.getElementById("phone").value.replace(/\D/g, "");

    if (rawPhone.startsWith("8")) rawPhone = "7" + rawPhone.slice(1);
    if (rawPhone.startsWith("9")) rawPhone = "7" + rawPhone;

    if (!/^7\d{10}$/.test(rawPhone)) {
      alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
      return;
    }

    const phone = "+" + rawPhone;
    closeLeadForm();

    const res = await fetch(LEAD_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, name, phone })
    });

    const data = await res.json();
    const msg = data.message || "–°–ø–∞—Å–∏–±–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏.";
    chatHistory.push({ role: "assistant", content: msg });
    await playTTS(msg);
  }

  document.querySelectorAll(".cta-button").forEach(btn => {
    btn.addEventListener("click", () => {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)(); // ‚Üê —Ç—É—Ç —Å–æ–∑–¥–∞—ë–º –ø–æ –∫–ª–∏–∫—É
      }
      if (!isRunning) {
        messages = [];
        chatHistory = [];
        dialogLoop();
      }
    });
  });

  document.getElementById("phone")?.addEventListener("input", function () {
    if (!this.value.startsWith("+7")) this.value = "+7";
    const digits = this.value.slice(2).replace(/\D/g, "").slice(0, 10);
    this.value = "+7" + digits;
  });
</script>

<style>
  @keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.5); opacity: 0.5; }
    100% { transform: scale(1); opacity: 1; }
  }
</style>
</body>
</html>
